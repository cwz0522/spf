<?xml version="1.0" ?>
<f:forth xmlns:f="http://forth.org.ru/ForthML/"
  xmlns="http://forth.org.ru/ForthML/Rules/"
>
<!-- Apr.2007 ruvim@forth.org.ru -->
<!-- $Id$ -->

<rule match="f:xt"><!-- only within f:def or f:p -->
  <m>
  <f:lit> BFW, <f:p><yield/></f:p> RFW </f:lit>
  </m>
</rule>

<rule match="f:ahead"><m>
  <direct>BFW,</direct><yield/><direct>RFW</direct>
  </m>
</rule>

<rule match="m0">
  M @ >R  M 0!  <yield/>  R> M !
</rule>

<rule match="mm"><!-- in addition to 'r:m' -->
  <m>
  <f:choose> STATE? <f:when>
    <m0> INC-M <yield/> DEC-M </m0>
  </f:when><f:otherwise>
    <yield/>
  </f:otherwise></f:choose>
  </m>
</rule>

<f:def name="(yield2)" ds=" state -- ">
  STATE @ >R STATE ! trans-childs R> STATE !
</f:def>

<rule match="yield"><!-- because of r:mm -->
  <!-- only within non-nested r:rule -->
  STATE @ 0 EQ <f:if> 5006 THROW </f:if>
  <f:choose>
  STATE @ 1 EQ
  <f:when> <f:xt-of name="trans-childs"/> EXEC, </f:when>
  <f:otherwise> STATE @ 1- LIT, <f:xt-of name="(yield2)"/> EXEC, </f:otherwise>
  </f:choose>
</rule>

<rule match="f:times"><mm>
  <f:repeat> DUP <f:while/> >R <yield/> R> 1- </f:repeat> DROP
  </mm>
</rule>

<rule match="f:d"><!-- dynamic binding (for native words only) -->
  FirstChildValue
  <f:repeat> WORD|TAIL 2>R DUP <f:while />
    T-SLIT <m> &amp; EXECUTE </m>
  2R>
  </f:repeat>
  2DROP RDROP RDROP
</rule>

<f:def name="t-child-slit">
  cnode firstChild <f:choose> DUP <f:when> nodeValue T-SLIT </f:when> 0 T-2LIT </f:choose>
</f:def>

<rule match="f:emit">
  t-child-slit <m>TYPE</m>
</rule>

<rule match="f:emit-line">
  t-child-slit <m>TYPE CR</m>
</rule>

<rule match="f:wordlist"><mm>
  WORDLIST GET-CURRENT >CS
  DUP SET-CURRENT ALSO CONTEXT !
  <yield/>
  CONTEXT @ <!-- wid -->
  CS> SET-CURRENT PREVIOUS
  <get-attribute name="name"/> 
  <f:choose> DUP <f:when> ROT <f:p><f:lit/></f:p> NAMING </f:when> 2DROP </f:choose>
  </mm>
</rule>

<rule match="f:export"><!-- child of f:wordlist only -->
  <mm>
  CS@ GET-CURRENT >CS  SET-CURRENT
  <yield/>
  CS> SET-CURRENT
  </mm>
</rule>

<rule match="f:also"><!-- immediately effect! -->
  `apply GetAttribute &amp; EXECUTE ALSO CONTEXT !
  <yield/>
  PREVIOUS
</rule>

<rule match="f:const"><mm>
  <yield/>
  <f:p><f:lit/></f:p><get-attribute name="name"/> NAMING-
  </mm>
</rule>

<rule match="f:cell">
  <f:choose> cnode firstChild <f:when><yield/></f:when><m>0</m></f:choose>
  <mm> HERE SWAP , <f:p><f:lit/></f:p> <get-attribute name="name"/> NAMING- </mm>
</rule>

<rule match="f:cell2">
  <f:choose> cnode firstChild <f:when><yield/></f:when><m>0 0</m></f:choose>
  <mm> ALIGN HERE 2 CELLS ALLOT DUP >CS 2! CS> <f:p><f:lit/></f:p> <get-attribute name="name"/> NAMING- </mm>
</rule>

<rule match="f:let"><mm><!-- ( x addr - ) -->
  DUP DUP @ 2>R !  <yield/>  R> R> !
  </mm>
</rule>

</f:forth>
