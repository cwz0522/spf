<?xml version="1.0" encoding="ASCII" ?>
<forth xmlns="http://forth.org.ru/ForthML/">
<!-- Feb.2007 ruvim@forth.org.ru -->

<def name="name-n-uri" ds=" qname-a qname-u -- name-a name-u uri-a uri-u ">
  `: SPLIT- 0= <if> 0 0 </if>  Namespace-uri-for-prefix
</def>

<def name="advice-rule-after" ds=" xt -- ">
  <p><exec>a-trans @</exec> DUP <if><exit/></if> DROP <exec/></p> a-trans !
</def>
<def name="advice-rule-before" ds=" xt -- ">
  <p><exec/> DUP <if><exit/></if> DROP <exec>a-trans @</exec></p> a-trans !
</def>

<def name="trans-node-force" ds="i*x -- i*x | j*x">
  a-trans @ EXECUTE <if><exit/></if> 5321 THROW
</def>

<def name="trans-childs" ds=" i*x -- j*x ">
  cnode >R
  FirstChild <repeat> cnode <while/> trans-node-force NextSibling </repeat>
  R> cnode!
</def>

<def name="trans-document" ds=" doc -- ">
  cnode >R documentElement cnode! trans-childs R> cnode!
</def>

<include href="document-context.f.xml"/>

<def name="EMBODY" ds=" i*x url-a url-u -- j*x ">
  2DUP
  DefaultLSParser parseURI DUP 0= <if> 5003 THROW </if>
  DUP >R <!-- ( a u doc ) -->
  push-document
  R@ trans-document R> DefaultLSParser freeDoc
  drop-document
</def>

<def name="Embody" ds=" i*x url-a url-u -- j*x "><!-- takes into account baseURI of current node -->
  2DUP `/ SPLIT- <if> `: SUBSTRING-BEFORE NIP <if>
    2DROP EMBODY <!-- by full path -->
    <exit/>
  </if></if> 2DROP

  cnode-based-url EMBODY
</def>

</forth>