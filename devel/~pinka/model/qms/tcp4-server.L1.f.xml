<?xml version="1.0" ?>
<forth xmlns="http://forth.org.ru/ForthML/">

<cell name="_sock" />
<cell name="_ip"   />
<cell name="_port" />
<cell name="_last-accepted" />

<def name="(close-listen)" ds=" -- ">
  <rem> closing FIRE-EVENT <!-- before --></rem>
  _sock @ _sock 0! CloseSocket THROW
</def>

<def name="close-listen" ds=" -- ">
  _sock @ 0EQ <if><exit/></if> (close-listen)
</def>

<def name="alive?" ds=" -- sock|0 ">
  _sock @
</def>

<def name="open-listen" ds=" -- ">
  close-listen
  CreateSocket THROW _sock !
  _sock @ ReuseAddrSocket THROW
  _port @ _ip @
  _sock @ BindSocketInterface THROW
  _sock @ ListenSocket THROW
  <rem> opening FIRE-EVENT <!-- after --></rem>
</def>

<def name="assume-listen" ds=" port-a port-u interface-a interface-u -- ">
  <choose> DUP <when> GetHostIP THROW </when> NIP </choose> _ip !
  StoN _port !
</def>

<def name="accept-client" ds=" -- sock ">
  _sock @ AcceptSocket THROW DUP _last-accepted !
</def>

</forth>
