<?xml version="1.0" encoding="ASCII"?>
<forth xmlns="http://forth.org.ru/ForthML/">

<rem><bind-up>
  accept-request?
  treat-request
</bind-up></rem>


<def name="allow-pipelining?" ds=" -- flag ">
  FALSE <!-- not supported yet -->
</def>

<def name="connection-alive?" ds=" -- flag ">
  sock <unless> FALSE <exit/></unless>
  connection-close? 0EQ
</def>

<def name="log-error" ds=" code -- ">
  DUP -2 EQ <if> DROP LAST-ERROR-MSG <logS>error, -2</logS><exit/></if>
  <logN>error, ior</logN>
</def>

<def name="treat-error" ds=" ior|0 -- ">
  DUP <unless> DROP <exit/></unless>
  <choose>
    DUP 10058 EQ <when>
      <logN>WSAESHUTDOWN</logN> 0 sock! 0
    </when>

    DUP 10054 EQ <when>
      <logN>WSAECONNRESET</logN> 0
    </when>

    DUP 10060 EQ <when>
      <logN>WSAETIMEDOUT</logN> 0
    </when>
    
  </choose><rem>( ior|0 )</rem>
  DUP
  <xt-of name="treat-error-lite" ds=" ior -- "/> CATCH <rem>( ior 0 | ior x ior2 )</rem>
    DUP <if> NIP   DUP <logN>error, treat-error-lite</logN></if> DROP
    <rem>( ior|0 )</rem>
  DUP <unless> DROP <exit/></unless>
  log-error
</def>
   
<def name="treat-request-async" ds=" -- ">
  <emit-line>treat-request-async -- to be provided</emit-line> ABORT
</def>

<def name="dispatch-request" ds=" -- ">
  allow-pipelining?    <if> connection-close? <unless> has-content <unless>
  treat-request-async  <exit/></unless></unless></if>
  treat-request

  <!-- 8.1.2.2 Pipelining 
    Clients SHOULD NOT pipeline requests using non-idempotent methods
    or non-idempotent sequences of methods 
  -->
</def>

<def name="(perform-dialog)" ds=" -- ">
  <until> sock <while/>
    accept-request?
  <while/>
    dispatch-request
    connection-close?
  </until>
</def>

<def name="perform-dialog" ds=" -- ">
  <xt-of name="(perform-dialog)"/> CATCH treat-error
</def>

<def name="treat-client" ds=" sock -- ">
  DUP <logN>begin dialog</logN>
  assume-sock
  perform-dialog
  <log>end dialog</log>
  close-socketline
</def>

</forth>
