<?xml version="1.0" encoding="ASCII"?>
<forth xmlns="http://forth.org.ru/ForthML/">

<cell name="_buf-size"> 64 1024 * <rem> buffer size for reading chunks </rem></cell>

<slot> consumer-xt content-rest </slot>
<comment>
  content-rest should be set from the outside
</comment>

<handler event="cleanup">
  0 content-rest!
</handler>

<def name="content-per-catch" ds=" xt -- ior "><rem> xt ( a u -- ) </rem>
  <rem> reads what the rest by content-rest value </rem>
  consumer-xt!
  _buf-size @ DUP ALLOCATE DUP <if> NIP NIP <exit/></if> DROP SWAP
  <rem>( a-buf u-buf )</rem>
  OVER >R
  <q ds=" a u -- a u1 ">
    <repeat> content-rest <while/>
       content-rest UMIN 2DUP 2>R
       readout DUP <unless> -1002 THROW </unless>
       content-rest OVER - content-rest!
       consumer-xt EXECUTE
       2R>
    </repeat>
  </q> CATCH NIP NIP
  0 consumer-xt!
  R> FREE OVER <unless> NIP <exit/></unless> DROP
</def>

<def name="with-content" ds=" xt -- "><rem> xt ( a u -- ) </rem>
  <rem> reads what the rest by content-rest value </rem>
  content-rest ALLOCATED OVER >R
  <q ds=" xt a u -- "> 
    2DUP read-exact
    0 content-rest!
    ROT EXECUTE 
  </q> CATCH
  R> FREE SWAP THROW THROW
</def>

</forth>
