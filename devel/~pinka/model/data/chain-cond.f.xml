<?xml version="1.0" encoding="windows-1251" ?>
<forth xmlns="http://forth.org.ru/ForthML/">
<!-- 2007 -->
<comment>See also: http://en.wikipedia.org/wiki/Chain-of-responsibility_pattern</comment>

<!-- require list-plain.f.xml -->

<cell name="chain-current"/>
<cell name="chain-context"/>

<cell name="chain-context-node"/>
<cell name="chain-tree-stack"/>

<def name="advice-before" ds=" xt -- ">
  0 , HERE SWAP , chain-current @ BIND-NODE
</def>
<def name="advice-after" ds=" xt -- ">
  0 , HERE SWAP , chain-current @ BIND-NODE-TAIL
</def>

<def name="perform-node-cond" ds=" i*x node -- j*x flag ">
<rem> see also: list-plain.f.xml/PERFORM-NODE-COND </rem>
  chain-tree-stack   @ >R
  chain-context-node @ >R
  RP@ chain-tree-stack !
  <repeat> DUP <while/> DUP chain-context-node ! @ EXECUTE  DUP 0EQ <while/> 
    DROP chain-context-node @ CELL- @
  </repeat><!-- ( true|false ) -->
  R> chain-context-node !
  R> chain-tree-stack   !
</def>
<def name="perform-chain-explicit" ds=" i*x h -- j*x flag ">
  @ perform-node-cond
</def>
<comment>
  Цепочки могут неформально сцеплятся через perform-chain-explicit в обработчике,
  что ведет к образованию дерева узлов. Операция perform-chain-next должна
  отработать все оставшиеся узлы в порядке обхода дерева, а не только
  текущую цепочку. Для реализации такого обхода, все точки ветвления
  сохраняются в список, размещаемый на стеке возвратов. Ячейка
  chain-tree-stack ведет на голову этого списка. При вложенном поиске
  следующего узла этот список рекурсивно разматывается, а после завершения
  операции возвращается на место. Разматывать его необходимо для
  избегания бесконечной косвенной рекурсии.
</comment>
<def name="perform-chain-next" ds=" i*x -- j*x flag ">
  chain-context-node @ CDR DUP <unless><exit/></unless>
  perform-node-cond DUP <if><exit/></if> DROP
  chain-tree-stack @ 2@ DUP <unless><rem> context-node is null </rem> NIP <exit/></unless>
  chain-tree-stack   @ >R
  chain-context-node @ >R
  chain-context-node !
  chain-tree-stack   !
  <recurse/>
  R> chain-context-node !
  R> chain-tree-stack   !
</def>
<def name="perform-chain" ds=" i*x -- j*x flag ">
  chain-context @ DUP <unless><exit/></unless>
  perform-chain-explicit
</def>
<def name="perform-chain-sure" ds=" i*x -- j*x ">
  perform-chain <if><exit/></if> ABORT
</def>

</forth>
