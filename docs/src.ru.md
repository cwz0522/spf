<a id="start"/>

Устройство [SPF](readme.ru.html)
================================

<title>Устройство SPF</title>

<i>Описание внутреннего устройства SPF</i>

<small>Последнее обновление: $Date$</small>

<!-- $Revision$ -->

----

[[Английский](src.en.html)] [[Русский](src.ru.html)] 

----

##Содержание

* [Распределение регистров](#regs)
* [Карта памяти](#memmap)
* [Динамическая память](#heap)
* [Хранилище](#image)
* [Стеки](#stack)

----
<a id="regs"/>
###[Распределение регистров][start]

* EAX - вершина стека
* EBP - указатель на стек данных
* [EBP] - второй элемент стека данных
* ESP - указатель на стек возвратов
* EDI - указатель на данные потока


----
<a id="memmap"/>
###[Карта памяти][start]

qqq


----
<a id="heap"/>
###[Динамическая память][start]

У каждого потока свой хип. `ALLOCATE` выделает память из хипа потока, в контексте 
которого вызвано.

Хип процесса ядром форт-системы не используется.
(хотя в принципе, его можно использовать, и некоторые расширения делают это).
При доступе к разделяемому хипу стоит вспомнить о необходимости синхронизации.


---
<a id="image"/>
###[Хранилище][start]

Контекст (`ORDER`, `CURRENT`) у каждого потока свой
(по умолчанию: `ONLY FORTH DEFINITIONS` ).
Поддерживается параллельная интерпретация.

Компиляция должна осуществляться только одним потоком (во избежание).

Код и данные хранятся в едином хранилище (сегменте, кодофайле).
Слова доступа к нему стандартные : `HERE` `ALLOT` `,` `C,`
Слово `UNUSED` вынесено в lib\include\core-ext.f

`IMAGE-BASE` - начало хранилища.

`IMAGE-SIZE` - резервируемый размер.

Временные словари (  `TEMP-WORDLIST`  `FREE-WORDLIST` ).
Такой словарь ассоциирован с собственным хранилищем
(память для которого распределяется динамически).

Когда такой словарь(список) является текущим (`CURRENT`)
(словарем компиляции, целевым, в который добавляются слова)
`HERE` дает начало свободной области его хранилища.


----
<a id="stack"/>
###[Стеки][start]

Стек возвратов совмещен с аппаратным стеком.
Стек параметров адресуется регистром EBP, вершина стека хранится в EAX

Указатели стеков: `SP@` `RP@` `SP!` `RP!`

Дно стеков: `S0` `R0` 

( `src/compiler/spf_translate.f` )



[start]: #start
