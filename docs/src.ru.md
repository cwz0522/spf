<a id="start"/>

Устройство [SPF](readme.ru.html)
================================

<title>Устройство SPF</title>

<i>Описание внутреннего устройства SPF</i>

<small>Последнее обновление: $Date$</small>

<!-- $Revision$ -->

----

[[Английский](src.en.html)] [[Русский](src.ru.html)] 

----

##Содержание

* [Распределение регистров](#regs)
* [Стеки](#stack)
* [Хранилище](#image)
* [Динамическая память](#heap)
* [Словарная статья](#article)
* [Перекомпиляция ядра](#make-kernel)

----
<a id="regs"/>
###[Распределение регистров][start]

* EAX - вершина стека
* EBP - указатель стек данных
* [EBP] - второй элемент стека данных
* ESP - указатель на стек возвратов
* EDI - указатель на данные потока (указывает на начало USER-области текущего потока)

----
<a id="stack"/>
###[Стеки][start]

Стек возвратов совмещен с аппаратным стеком.
Стек параметров адресуется регистром EBP, вершина стека хранится в EAX

Указатели стеков: `SP@` `RP@` `SP!` `RP!`

Дно стеков: `S0` `R0` 

Оба стека начиная от своего дна, растут вниз (в сторону уменьшения адресов).

( `src/compiler/spf_translate.f` )

----
<a id="image"/>
###[Хранилище][start]

Контекст (`ORDER`, `CURRENT`) у каждого потока свой
(по умолчанию: `ONLY FORTH DEFINITIONS` ).
Поддерживается параллельная интерпретация.

Компиляция в одно хранилище должна осуществляться только одним потоком (во избежание).

Код и данные хранятся в едином хранилище (сегменте, кодофайле).
Слова доступа к нему стандартные : `HERE` `ALLOT` `,` `C,`
Слово `UNUSED` вынесено в `lib\include\core-ext.f`

<img src="images/src_static.png"/>

`IMAGE-BASE` - начало хранилища.

`IMAGE-SIZE` - резервируемый размер.

Временные словари (  `TEMP-WORDLIST`  `FREE-WORDLIST` ).
Такой словарь ассоциирован с собственным хранилищем
(память для которого распределяется динамически).

Когда такой словарь (список) является текущим (`CURRENT`)
(словарем компиляции, целевым, в который добавляются слова)
`HERE` дает начало свободной области его хранилища.


----
<a id="heap"/>
###[Динамическая память][start]

<img src="images/src_heap.png"/>

У каждого потока свой хип. `ALLOCATE` выделяет память из хипа потока, в контексте 
которого вызвано.

Хип процесса ядром форт-системы не используется.
(хотя в принципе, его можно использовать, и некоторые расширения делают это).
При доступе к разделяемому хипу стоит вспомнить о необходимости синхронизации.

Кроме отдельной кучи каждый поток имеет свой собственный блок статических данных
-- USER-область (размером `EXTRA-MEM`, по-умолчанию 8кб). Переменные и массивы 
резервируются там словами словами `USER` , `USER-VALUE` .


----
<a id="article"/>
###[Словарная статья][start]

Словарь является односвязным списком с полем имени (его адрес обозначаемый как NFA 
используется для идентификации конкретной словарной статьи в словаре), полем кода 
в котором хранится `xt` действия данного слова, полем флагов (содержит признаки 
характеризующие это слово -- `&IMMEDIATE` и `&VOC` )

<img src="images/src_voc.png"/>

Т. н. "поля параметров" нет, так как "телом" определений в SPF являются последовательности
машинных инструкций.

( `src/compiler/spf_wordlist.f` )

<a id="make-kernel"/>
###[Перекомпиляция ядра][start]

Компиляция ядра выполняется запуском bat-файла `src/compile.bat`. По умолчанию, 
сборку выполняет одна их младших версий SPF (jpf375c.exe в корневой папке), но
SPF может и сам собирать себя.

В файле `src/spf_compileoptions.f` задаются параметры новой сборки.


[start]: #start